<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Desktop Agent — Test Dashboard</title>
    <style>
        /* ── Reset & Base ───────────────────────────────────────── */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            background: #0a0a0f;
            color: #e0e0e0;
            padding: 24px;
            min-height: 100vh;
        }

        h1 { color: #7b68ee; margin-bottom: 8px; font-size: 24px; }
        h2 { color: #888; margin-bottom: 16px; font-size: 14px; font-weight: normal; }
        h3 { color: #7b68ee; margin-bottom: 12px; font-size: 16px; }

        /* ── Layout ─────────────────────────────────────────────── */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: #12121a;
            border: 1px solid #1e1e2e;
            border-radius: 12px;
            padding: 20px;
        }

        /* ── Connection Status ──────────────────────────────────── */
        #connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 16px;
        }
        .connected { background: #1a3a1a; color: #4caf50; }
        .disconnected { background: #3a1a1a; color: #f44336; }

        /* ── Biometric State Badge ──────────────────────────────── */
        .state-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .state-DEEP_FOCUS { background: #1a1a3a; color: #7b68ee; }
        .state-STRESSED { background: #3a1a1a; color: #ff6b6b; }
        .state-FATIGUED { background: #3a2a1a; color: #ffa726; }
        .state-RELAXED { background: #1a3a1a; color: #66bb6a; }
        .state-WIRED { background: #3a3a1a; color: #ffee58; }

        /* ── Biometric Data ─────────────────────────────────────── */
        .bio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        .bio-item {
            background: #1a1a24;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .bio-value {
            font-size: 24px;
            font-weight: bold;
            color: #7b68ee;
        }
        .bio-label {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* ── Stress Gauge ──────────────────────────────────────── */
        .stress-gauge {
            margin-top: 16px;
            padding: 16px;
            background: #1a1a24;
            border-radius: 8px;
        }
        .stress-bar-container {
            width: 100%;
            height: 24px;
            background: #0a0a12;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }
        .stress-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease, background 0.5s ease;
            width: 0%;
        }
        .stress-bar.low { background: linear-gradient(90deg, #2e7d32, #4caf50); }
        .stress-bar.medium { background: linear-gradient(90deg, #f9a825, #ffca28); }
        .stress-bar.high { background: linear-gradient(90deg, #c62828, #ef5350); }
        .stress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 10px;
            color: #555;
        }
        .stress-value {
            font-size: 32px;
            font-weight: bold;
            display: inline-block;
        }
        .stress-value.low { color: #4caf50; }
        .stress-value.medium { color: #ffca28; }
        .stress-value.high { color: #ef5350; }
        .stress-label-text {
            font-size: 13px;
            color: #888;
            display: inline-block;
            margin-left: 8px;
        }

        /* ── HRV Display ───────────────────────────────────────── */
        .hrv-display {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        .hrv-item {
            background: #1a1a24;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .hrv-value {
            font-size: 22px;
            font-weight: bold;
            color: #7b68ee;
        }
        .hrv-pct { color: #4caf50; }
        .hrv-pct.warning { color: #ffca28; }
        .hrv-pct.danger { color: #ef5350; }

        /* ── Mock State Buttons ─────────────────────────────────── */
        .state-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .state-btn {
            padding: 8px 16px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a24;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .state-btn:hover {
            border-color: #7b68ee;
            background: #1a1a3a;
        }
        .state-btn.active {
            border-color: #7b68ee;
            background: #2a2a4a;
            color: #7b68ee;
        }

        /* ── Intervention Feed ──────────────────────────────────── */
        .intervention {
            background: #1a1a24;
            border-left: 3px solid #7b68ee;
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 8px;
            animation: slideIn 0.3s ease;
        }
        .intervention.priority-critical { border-left-color: #f44336; }
        .intervention.priority-high { border-left-color: #ff9800; }
        .intervention.priority-medium { border-left-color: #7b68ee; }
        .intervention.priority-low { border-left-color: #4caf50; }

        .intervention-message { font-size: 14px; line-height: 1.5; }
        .intervention-meta {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
        }

        .intervention-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .intervention-btn {
            padding: 4px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #12121a;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
        }
        .intervention-btn:hover { border-color: #7b68ee; color: #fff; }

        #intervention-feed {
            max-height: 500px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            color: #444;
            padding: 40px;
            font-style: italic;
        }

        /* ── Log ────────────────────────────────────────────────── */
        #log {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
            padding: 12px;
            background: #0a0a12;
            border-radius: 8px;
        }
        .log-entry { margin-bottom: 2px; }
        .log-entry .time { color: #444; }

        /* ── Game Mode Panel ──────────────────────────────────── */
        .app-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .app-btn {
            padding: 8px 14px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a24;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            min-width: 80px;
        }
        .app-btn:hover {
            border-color: #7b68ee;
            background: #1a1a3a;
        }
        .app-btn.active {
            border-color: #7b68ee;
            background: #2a2a4a;
            color: #7b68ee;
        }
        .current-app-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 12px;
            background: #1a1a3a;
            color: #7b68ee;
        }
        .current-app-badge.inactive {
            background: #1a1a1a;
            color: #555;
        }
        #custom-content {
            width: 100%;
            height: 120px;
            background: #0a0a12;
            border: 1px solid #333;
            border-radius: 8px;
            color: #e0e0e0;
            font-family: monospace;
            font-size: 12px;
            padding: 12px;
            resize: vertical;
            margin-top: 8px;
        }
        #custom-content:focus {
            outline: none;
            border-color: #7b68ee;
        }
        .send-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .send-row select {
            background: #1a1a24;
            border: 1px solid #333;
            border-radius: 8px;
            color: #e0e0e0;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
        }
        .send-row select:focus {
            outline: none;
            border-color: #7b68ee;
        }
        .send-btn {
            padding: 8px 20px;
            border: 1px solid #7b68ee;
            border-radius: 8px;
            background: #2a2a4a;
            color: #7b68ee;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .send-btn:hover {
            background: #3a3a5a;
        }
        .intervention .app-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            background: #1a1a3a;
            color: #7b68ee;
            margin-left: 8px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <h1>GHOST</h1>
    <h2>Desktop Agent — Test Dashboard</h2>
    <div id="connection-status" class="disconnected">Disconnected</div>

    <div class="grid">
        
        <div>
            <div class="card">
                <h3>Biometric State</h3>
                <div id="state-badge" class="state-badge state-RELAXED">RELAXED</div>
                <div class="bio-grid">
                    <div class="bio-item">
                        <div class="bio-value" id="hr">--</div>
                        <div class="bio-label">Heart Rate</div>
                    </div>
                    <div class="bio-item">
                        <div class="bio-value" id="recovery">--</div>
                        <div class="bio-label">Recovery %</div>
                    </div>
                    <div class="bio-item">
                        <div class="bio-value" id="strain">--</div>
                        <div class="bio-label">Strain</div>
                    </div>
                    <div class="bio-item">
                        <div class="bio-value" id="sleep">--</div>
                        <div class="bio-label">Sleep %</div>
                    </div>
                </div>
            </div>

            
            <div class="card" style="margin-top: 20px;">
                <h3>Stress Level</h3>
                <div class="stress-gauge">
                    <span id="stress-value" class="stress-value low">0.0</span>
                    <span id="stress-label" class="stress-label-text">Low Stress</span>
                    <div class="stress-bar-container">
                        <div id="stress-bar" class="stress-bar low" style="width: 0%"></div>
                    </div>
                    <div class="stress-labels">
                        <span>0 — Low</span>
                        <span>1 — Medium</span>
                        <span>2 — High</span>
                        <span>3</span>
                    </div>
                </div>

                <h3 style="margin-top: 16px;">HRV</h3>
                <div class="hrv-display">
                    <div class="hrv-item">
                        <div class="hrv-value" id="hrv-current">--</div>
                        <div class="bio-label">Current (ms)</div>
                    </div>
                    <div class="hrv-item">
                        <div class="hrv-value" id="hrv-baseline">--</div>
                        <div class="bio-label">Baseline (ms)</div>
                    </div>
                    <div class="hrv-item">
                        <div class="hrv-value hrv-pct" id="hrv-pct">--%</div>
                        <div class="bio-label">% of Baseline</div>
                    </div>
                </div>

                <div class="bio-grid" style="margin-top: 12px; grid-template-columns: 1fr 1fr;">
                    <div class="bio-item">
                        <div class="bio-value" id="spo2">--</div>
                        <div class="bio-label">SpO2 %</div>
                    </div>
                    <div class="bio-item">
                        <div class="bio-value" id="skin-temp">--</div>
                        <div class="bio-label">Skin Temp °C</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Mock Biometric Controls</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
                    Click a state to simulate that biometric profile
                </p>
                <div class="state-buttons">
                    <button class="state-btn" onclick="setMockState(1)">1: Deep Focus</button>
                    <button class="state-btn" onclick="setMockState(2)">2: Stressed</button>
                    <button class="state-btn" onclick="setMockState(3)">3: Fatigued</button>
                    <button class="state-btn active" onclick="setMockState(4)">4: Relaxed</button>
                    <button class="state-btn" onclick="setMockState(5)">5: Wired</button>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Game Mode — Content Simulator</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
                    Send sample content as if a player interacted with an in-game app
                </p>
                <div id="current-app" class="current-app-badge inactive">No app active</div>

                <div class="app-buttons">
                    <button class="app-btn" onclick="sendSampleContent('code')">Code Editor</button>
                    <button class="app-btn" onclick="sendSampleContent('terminal')">Terminal</button>
                    <button class="app-btn" onclick="sendSampleContent('browser')">Browser</button>
                    <button class="app-btn" onclick="sendSampleContent('notes')">Notes</button>
                    <button class="app-btn" onclick="sendSampleContent('chat')">Chat</button>
                </div>

                <div style="margin-top: 16px;">
                    <label style="font-size: 12px; color: #888;">Custom Content</label>
                    <textarea id="custom-content" placeholder="Type content here to send to Ghost as any app type..."></textarea>
                    <div class="send-row">
                        <select id="app-type-select">
                            <option value="code">code</option>
                            <option value="terminal">terminal</option>
                            <option value="browser">browser</option>
                            <option value="notes">notes</option>
                            <option value="chat">chat</option>
                        </select>
                        <button class="send-btn" onclick="sendCustomContent()">Send Content</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Log</h3>
                <div id="log"></div>
            </div>
        </div>

        
        <div>
            <div class="card">
                <h3>Ghost Interventions</h3>
                <div id="intervention-feed">
                    <div class="empty-state">
                        Waiting for Ghost to speak...<br>
                        Ghost watches your screen and speaks when it detects<br>
                        you're stuck, making a mistake, or could use help.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ── State ────────────────────────────────────────────────
        let ws = null;
        let reconnectTimer = null;
        // Store the HRV baseline from the status API (updated via /api/status)
        let currentHrvBaseline = 50;

        // ── WebSocket Connection ─────────────────────────────────
        function connect() {
            ws = new WebSocket("ws://localhost:8000/ws");

            ws.onopen = () => {
                document.getElementById("connection-status").className = "connected";
                document.getElementById("connection-status").textContent = "Connected";
                log("WebSocket connected");
                // Fetch full status to get hrv_baseline
                fetchStatus();
            };

            ws.onclose = () => {
                document.getElementById("connection-status").className = "disconnected";
                document.getElementById("connection-status").textContent = "Disconnected";
                log("WebSocket disconnected — reconnecting in 3s...");
                // Auto-reconnect after 3 seconds
                reconnectTimer = setTimeout(connect, 3000);
            };

            ws.onerror = (err) => {
                log("WebSocket error");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        // ── Fetch Status API (for HRV baseline) ──────────────────
        async function fetchStatus() {
            try {
                const resp = await fetch("/api/status");
                const data = await resp.json();
                if (data.hrv_baseline) {
                    currentHrvBaseline = data.hrv_baseline;
                    document.getElementById("hrv-baseline").textContent =
                        Math.round(data.hrv_baseline);
                }
                // Update game mode current app display
                const appBadge = document.getElementById("current-app");
                if (appBadge && data.game_mode !== undefined) {
                    if (data.current_app) {
                        appBadge.textContent = `Active: ${data.current_app}`;
                        appBadge.className = "current-app-badge";
                    } else {
                        appBadge.textContent = "No app active";
                        appBadge.className = "current-app-badge inactive";
                    }
                }
            } catch (err) {
                // silently fail — not critical
            }
        }

        // ── Message Handler ──────────────────────────────────────
        function handleMessage(data) {
            if (data.type === "biometric_update") {
                updateBiometrics(data);
            } else if (data.type === "state_change") {
                log(`State changed: ${data.from} → ${data.to} (${data.reason})`);
                updateStateBadge(data.to);
                if (data.estimated_stress !== undefined) {
                    updateStressGauge(data.estimated_stress);
                }
            } else if (data.type === "intervention") {
                addIntervention(data);
            }
        }

        // ── Update Biometric Display ─────────────────────────────
        function updateBiometrics(data) {
            document.getElementById("hr").textContent = data.heartRate || "--";
            document.getElementById("recovery").textContent = data.recovery || "--";
            document.getElementById("strain").textContent = data.strain || "--";
            document.getElementById("sleep").textContent =
                data.sleepPerformance ? Math.round(data.sleepPerformance * 100) + "%" : "--";

            // Update HRV display
            if (data.hrv !== undefined) {
                const hrv = data.hrv;
                document.getElementById("hrv-current").textContent =
                    hrv ? hrv.toFixed(1) : "--";

                // Calculate percentage of baseline
                if (hrv && currentHrvBaseline > 0) {
                    const pct = Math.round((hrv / currentHrvBaseline) * 100);
                    const pctEl = document.getElementById("hrv-pct");
                    pctEl.textContent = pct + "%";
                    // Color based on ratio
                    pctEl.className = "hrv-value hrv-pct";
                    if (pct < 60) pctEl.classList.add("danger");
                    else if (pct < 85) pctEl.classList.add("warning");
                }
            }

            // Update SpO2 and skin temp
            if (data.spo2 !== undefined) {
                document.getElementById("spo2").textContent =
                    data.spo2 ? data.spo2.toFixed(1) : "--";
            }
            if (data.skinTemp !== undefined) {
                document.getElementById("skin-temp").textContent =
                    data.skinTemp ? data.skinTemp.toFixed(1) : "--";
            }

            // Update stress gauge
            if (data.estimated_stress !== undefined) {
                updateStressGauge(data.estimated_stress);
            }

            if (data.state) {
                updateStateBadge(data.state);
            }
        }

        // ── Update Stress Gauge ───────────────────────────────────
        function updateStressGauge(stress) {
            const valueEl = document.getElementById("stress-value");
            const labelEl = document.getElementById("stress-label");
            const barEl = document.getElementById("stress-bar");

            valueEl.textContent = stress.toFixed(1);

            // Width: stress/3 * 100%
            const widthPct = Math.min((stress / 3) * 100, 100);
            barEl.style.width = widthPct + "%";

            // Color and label based on stress level
            valueEl.className = "stress-value";
            barEl.className = "stress-bar";
            if (stress < 1.0) {
                valueEl.classList.add("low");
                barEl.classList.add("low");
                labelEl.textContent = "Low Stress";
            } else if (stress < 2.0) {
                valueEl.classList.add("medium");
                barEl.classList.add("medium");
                labelEl.textContent = "Medium Stress";
            } else {
                valueEl.classList.add("high");
                barEl.classList.add("high");
                labelEl.textContent = "High Stress";
            }
        }

        function updateStateBadge(state) {
            const badge = document.getElementById("state-badge");
            badge.textContent = state;
            badge.className = "state-badge state-" + state;
        }

        // ── Add Ghost Intervention to Feed ───────────────────────
        function addIntervention(data) {
            const feed = document.getElementById("intervention-feed");

            // Remove the "waiting" placeholder if it exists
            const empty = feed.querySelector(".empty-state");
            if (empty) empty.remove();

            // Create intervention card
            const div = document.createElement("div");
            div.className = `intervention priority-${data.priority || "medium"}`;

            // Message
            const msg = document.createElement("div");
            msg.className = "intervention-message";
            msg.textContent = data.message;
            div.appendChild(msg);

            // Meta info
            const meta = document.createElement("div");
            meta.className = "intervention-meta";
            const time = new Date().toLocaleTimeString();
            let metaText = `${time} · ${data.priority} · ${data.state} · ${data.reason || ""}`;
            if (data.app_type) metaText += ` · app: ${data.app_type}`;
            if (data.risky) metaText += ` · ⚠ RISKY`;
            meta.textContent = metaText;
            div.appendChild(meta);

            // Buttons
            if (data.buttons && data.buttons.length > 0) {
                const btnContainer = document.createElement("div");
                btnContainer.className = "intervention-buttons";

                data.buttons.forEach(label => {
                    const btn = document.createElement("button");
                    btn.className = "intervention-btn";
                    btn.textContent = label;
                    btn.onclick = () => sendFeedback(label);
                    btnContainer.appendChild(btn);
                });

                div.appendChild(btnContainer);
            }

            // Add to top of feed
            feed.insertBefore(div, feed.firstChild);

            log(`Ghost: "${data.message.substring(0, 60)}..." [${data.priority}]`);
        }

        // ── Send Feedback to Server ──────────────────────────────
        function sendFeedback(action) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "feedback", action: action }));
                log(`Feedback sent: ${action}`);
            }
        }

        // ── Mock State Control ───────────────────────────────────
        async function setMockState(num) {
            // Update button styles
            document.querySelectorAll(".state-btn").forEach((btn, i) => {
                btn.classList.toggle("active", i === num - 1);
            });

            try {
                const resp = await fetch("/api/biometric/mock", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ state: num })
                });
                const data = await resp.json();
                log(`Mock state set to ${num} (${data.state})`);
                // Re-fetch status to update HRV baseline display
                fetchStatus();
            } catch (err) {
                log(`Error setting mock state: ${err.message}`);
            }
        }

        // ── Log ──────────────────────────────────────────────────
        function log(message) {
            const logDiv = document.getElementById("log");
            const entry = document.createElement("div");
            entry.className = "log-entry";
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="time">[${time}]</span> ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep log bounded
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // ── Game Mode: Sample Content ─────────────────────────────
        const SAMPLE_CONTENT = {
            code: `def calculate_total(items):
    total = 0
    for item in items:
        total += item.price
    return total

result = calculate_total(None)
print(result)`,

            terminal: `$ npm run build

ghost@1.0.0 build
tsc && vite build

error TS2307: Cannot find module './components/Ghost' or its corresponding type declarations.
error TS2307: Cannot find module './utils/biometrics' or its corresponding type declarations.
$ npm run build

same errors repeating`,

            browser: `Page: TypeError: Cannot read properties of null (reading 'map') - Stack Overflow
URL: stackoverflow.com/questions/54321
Content: The error occurs because you're trying to call .map() on a variable that is null. You need to add a null check before calling .map(). Use optional chaining: data?.map() or add an if statement.`,

            notes: `project stuff:

fix the auth thing
maybe refactor login??
API is broken idk why
need to talk to matei about the frontend
deadline is friday i think
should we use firebase or supabase
too many bugs`,

            chat: `them: hey is the feature done?
me: almost, just fixing some bugs
them: you said that yesterday
me: yeah but I found more issues
them: the client is asking for a demo tomorrow
me: tomorrow?? nobody told me that
them: it was in the slack channel
me: which channel?`
        };

        // ── Game Mode: Send Functions ─────────────────────────────
        function sendSampleContent(appType) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log("WebSocket not connected");
                return;
            }
            const msg = {
                type: "content_update",
                app_type: appType,
                content: SAMPLE_CONTENT[appType]
            };
            // Add metadata for specific app types
            if (appType === "code") msg.language = "python";
            if (appType === "terminal") msg.shell = "bash";
            if (appType === "browser") msg.url = "stackoverflow.com/questions/54321";
            if (appType === "chat") msg.platform = "slack";

            ws.send(JSON.stringify(msg));
            log(`Sent ${appType} sample content (${SAMPLE_CONTENT[appType].length} chars)`);

            // Highlight the active app button
            document.querySelectorAll(".app-btn").forEach(btn => {
                btn.classList.toggle("active",
                    btn.textContent.toLowerCase().includes(appType));
            });
            // Update current app display
            const appBadge = document.getElementById("current-app");
            if (appBadge) {
                appBadge.textContent = `Active: ${appType}`;
                appBadge.className = "current-app-badge";
            }
        }

        function sendCustomContent() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log("WebSocket not connected");
                return;
            }
            const appType = document.getElementById("app-type-select").value;
            const content = document.getElementById("custom-content").value;
            if (!content.trim()) {
                log("No content to send");
                return;
            }
            ws.send(JSON.stringify({
                type: "content_update",
                app_type: appType,
                content: content
            }));
            log(`Sent custom ${appType} content (${content.length} chars)`);

            // Update current app display
            const appBadge = document.getElementById("current-app");
            if (appBadge) {
                appBadge.textContent = `Active: ${appType}`;
                appBadge.className = "current-app-badge";
            }
        }

        // ── Start ────────────────────────────────────────────────
        log("Ghost test dashboard loaded");
        connect();
        // Periodically fetch status to keep HRV baseline updated
        setInterval(fetchStatus, 15000);
    </script>
</body>
</html>
